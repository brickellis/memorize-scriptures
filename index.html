<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Study App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Loading Screen */
        .loading {
            text-align: center;
            padding: 50px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Selection Screen */
        .data-input {
            margin-bottom: 20px;
        }

        .data-input textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .selection-tree {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
        }

        .category {
            margin-bottom: 15px;
        }

        .category-header {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .subcategory {
            margin-left: 20px;
            margin-bottom: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .card-count {
            color: #666;
            font-size: 0.9em;
        }

        .selection-controls {
            text-align: center;
            margin-top: 20px;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 5px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: #95a5a6;
        }

        .btn.secondary:hover {
            background: #7f8c8d;
        }

        /* Session Screen */
        .session-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .progress {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }

        .card-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .flashcard {
            width: 100%;
            max-width: 500px;
            height: 300px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .flashcard:hover {
            transform: translateY(-2px);
        }

        .flashcard.flipped {
            background: #ecf0f1;
            border-color: #3498db;
        }

        .card-content {
            font-size: 18px;
            line-height: 1.4;
        }

        .card-side {
            display: none;
        }

        .card-side.active {
            display: block;
        }

        .flip-hint {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #666;
        }

        .session-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            min-width: 120px;
        }

        .control-btn.known {
            background: #27ae60;
        }

        .control-btn:hover {
            opacity: 0.9;
        }

        .keyboard-hint {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }

        .session-actions {
            text-align: center;
            margin-top: 20px;
        }

        /* Results Screen */
        .results {
            text-align: center;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success {
            color: #27ae60;
            background: #f2fdf2;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .resume-prompt {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .data-source {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .data-source h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .data-source p {
            color: #666;
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            .flashcard {
                height: 250px;
            }

            .session-controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 200px;
                margin-bottom: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Flashcard Study App</h1>

        <!-- Loading Screen -->
        <div id="loading-screen" class="screen active">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading flashcards from repository...</p>
            </div>
        </div>

        <!-- Selection Screen -->
        <div id="selection-screen" class="screen">
            <div class="data-source">
                <h3>Flashcard Data Source</h3>
                <p>Automatically loaded from: <strong>flashcards.json</strong></p>
                <p>You can also manually enter or modify JSON data below:</p>
            </div>

            <div class="data-input">
                <label for="json-input">Flashcard data (JSON format):</label>
                <textarea id="json-input" placeholder='Loading from flashcards.json...'></textarea>
                <button class="btn" onclick="loadData()">Reload Data</button>
            </div>
            <div id="resume-prompt" class="resume-prompt" style="display: none;">
                <p>You have a saved session in progress. Would you like to resume it?</p>
                <button class="btn" onclick="resumeSession()">Resume Session</button>
                <button class="btn secondary" onclick="startFresh()">Start Fresh</button>
            </div>
            <div id="selection-tree" class="selection-tree" style="display: none;">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="selection-controls">
                <button id="start-btn" class="btn" onclick="startSession()" disabled>Start Session</button>
                <button class="btn secondary" onclick="selectAll()">Select All</button>
                <button class="btn secondary" onclick="clearAll()">Clear All</button>
            </div>
            <div id="error-msg" class="error" style="display: none;"></div>
        </div>
        <!-- Session Screen -->
        <div id="session-screen" class="screen">
            <div class="session-header">
                <div id="progress" class="progress">Card 1 of 10</div>
            </div>
            <div class="card-container">
                <div id="flashcard" class="flashcard" onclick="flipCard()">
                    <div id="card-front" class="card-side active">
                        <div class="card-content"></div>
                    </div>
                    <div id="card-back" class="card-side">
                        <div class="card-content"></div>
                    </div>
                    <div class="flip-hint">Click to flip</div>
                </div>
            </div>
            <div class="keyboard-hint">
                Use ← (left arrow) for "Don't Know" and → (right arrow) for "Know It"
            </div>
            <div class="session-actions">
                <button class="btn secondary" onclick="pauseSession()">Pause Session</button>
                <button class="btn secondary" onclick="quitSession()">Quit Session</button>
            </div>
        </div>
        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <div class="results">
                <h2>Session Complete!</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div id="known-count" class="stat-number">0</div>
                        <div class="stat-label">Cards Mastered</div>
                    </div>
                    <div class="stat-item">
                        <div id="unknown-count" class="stat-number">0</div>
                        <div class="stat-label">Cards to Review</div>
                    </div>
                    <div class="stat-item">
                        <div id="session-time" class="stat-number">0m</div>
                        <div class="stat-label">Study Time</div>
                    </div>
                </div>
                <div>
                    <button id="continue-btn" class="btn" onclick="continueWithMissed()" style="display: none;">Continue
                        with Missed Cards</button>
                    <button class="btn secondary" onclick="backToSelection()">New Session</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        console.log('Starting Flashcard Study App...');
        // Global state
        let flashcardData = null;
        let sessionState = {
            selectedCards: [],
            currentQueue: [],
            currentCardIndex: 0,
            isFlipped: false,
            sessionActive: false,
            startTime: null,
            stats: { known: 0, unknown: 0 },
            knownCards: [],
            unknownCards: []
        };

        // Sample data for fallback
        const sampleData = {
            "categories": {
                "math": {
                    "name": "Mathematics",
                    "subcategories": {
                        "calculus": {
                            "name": "Calculus",
                            "cards": [
                                { "front": "What is a derivative?", "back": "The rate of change of a function at a point" },
                                { "front": "What is an integral?", "back": "The area under a curve or the reverse of differentiation" },
                                { "front": "What is the fundamental theorem of calculus?", "back": "Links differentiation and integration as inverse operations" }
                            ]
                        },
                        "algebra": {
                            "name": "Algebra",
                            "cards": [
                                { "front": "What is a quadratic equation?", "back": "An equation of the form ax² + bx + c = 0" },
                                { "front": "What is the quadratic formula?", "back": "x = (-b ± √(b²-4ac)) / 2a" }
                            ]
                        }
                    }
                },
                "science": {
                    "name": "Science",
                    "subcategories": {
                        "biology": {
                            "name": "Biology",
                            "cards": [
                                { "front": "What is photosynthesis?", "back": "The process by which plants convert light energy into chemical energy" },
                                { "front": "What is mitosis?", "back": "The process of cell division that produces two identical cells" }
                            ]
                        },
                        "chemistry": {
                            "name": "Chemistry",
                            "cards": [
                                { "front": "What is an atom?", "back": "The smallest unit of matter that retains the properties of an element" },
                                { "front": "What is a covalent bond?", "back": "A chemical bond formed by sharing electrons between atoms" }
                            ]
                        }
                    }
                }
            }
        };

        // Initialize app
        console.log('Initializing app...');
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Document loaded. Setting up event listeners...');
            setupEventListeners();
            console.log('App initialized. Loading flashcards...');
            loadFlashcardsFromRepo();
        });

        // Load flashcards from repository
        async function loadFlashcardsFromRepo() {
            try {
                const url = new URL('./flashcards.json', window.location.href);
                console.log('Full URL:', url.href);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!validateData(data)) {
                    throw new Error('Invalid data format in flashcards.json');
                }

                flashcardData = data;
                document.getElementById('json-input').value = JSON.stringify(data, null, 2);

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'success';
                successMsg.textContent = 'Successfully loaded flashcards from repository!';
                document.getElementById('selection-screen').insertBefore(successMsg, document.getElementById('selection-screen').firstChild);

                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 3000);

                renderSelectionTree();
                checkForSavedSession();
                showScreen('selection-screen');

            } catch (error) {
                console.error('Error loading flashcards.json:', error);

                // Fall back to sample data
                flashcardData = sampleData;
                document.getElementById('json-input').value = JSON.stringify(sampleData, null, 2);

                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error';
                errorMsg.innerHTML = `
                    <strong>Could not load flashcards.json:</strong> ${error.message}<br>
                    <small>Loaded sample data instead. You can modify the JSON below or ensure flashcards.json exists in your repository.</small>
                `;
                document.getElementById('selection-screen').insertBefore(errorMsg, document.getElementById('selection-screen').firstChild);

                renderSelectionTree();
                checkForSavedSession();
                showScreen('selection-screen');
            }
        }

        function setupEventListeners() {
            // Keyboard events
            document.addEventListener('keydown', function (e) {
                if (sessionState.sessionActive) {
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        markCard(false);
                    } else if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        markCard(true);
                    } else if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        flipCard();
                    }
                }
            });

            // Touch events for swipe
            let touchStartX = 0;
            let touchStartY = 0;
            const flashcard = document.getElementById('flashcard');

            flashcard.addEventListener('touchstart', function (e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });

            flashcard.addEventListener('touchend', function (e) {
                if (!sessionState.sessionActive) return;

                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                // Check if it's a horizontal swipe (not vertical)
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    e.preventDefault();
                    if (diffX > 0) {
                        markCard(true); // Swipe right = know it
                    } else {
                        markCard(false); // Swipe left = don't know
                    }
                }
            });
        }

        function checkForSavedSession() {
            const savedSession = getCookie('flashcard_session');
            if (savedSession) {
                const resumePrompt = document.getElementById('resume-prompt');
                resumePrompt.style.display = 'block';
            }
        }

        function loadData() {
            const jsonInput = document.getElementById('json-input').value.trim();
            const errorMsg = document.getElementById('error-msg');

            if (!jsonInput) {
                showError('Please enter JSON data');
                return;
            }

            try {
                flashcardData = JSON.parse(jsonInput);
                if (!validateData(flashcardData)) {
                    showError('Invalid data format. Please check your JSON structure.');
                    return;
                }

                renderSelectionTree();
                errorMsg.style.display = 'none';

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'success';
                successMsg.textContent = 'Data loaded successfully!';
                document.getElementById('selection-screen').insertBefore(successMsg, document.getElementById('selection-tree'));

                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 3000);

            } catch (e) {
                showError('Invalid JSON format: ' + e.message);
            }
        }

        function validateData(data) {
            return data && data.categories && typeof data.categories === 'object';
        }

        function renderSelectionTree() {
            const tree = document.getElementById('selection-tree');
            tree.innerHTML = '';
            tree.style.display = 'block';

            for (const [categoryId, category] of Object.entries(flashcardData.categories)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';

                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';

                const categoryCheckbox = document.createElement('div');
                categoryCheckbox.className = 'checkbox-item';
                categoryCheckbox.innerHTML = `
                    <input type="checkbox" id="cat-${categoryId}" onchange="toggleCategory('${categoryId}')">
                    <label for="cat-${categoryId}">${category.name}</label>
                    <span class="card-count">(${getTotalCards(category)} cards)</span>
                `;

                categoryHeader.appendChild(categoryCheckbox);
                categoryDiv.appendChild(categoryHeader);

                if (category.subcategories) {
                    for (const [subId, subcategory] of Object.entries(category.subcategories)) {
                        const subDiv = document.createElement('div');
                        subDiv.className = 'subcategory';
                        subDiv.innerHTML = `
                            <div class="checkbox-item">
                                <input type="checkbox" id="sub-${categoryId}-${subId}" onchange="updateSelectionCount()">
                                <label for="sub-${categoryId}-${subId}">${subcategory.name}</label>
                                <span class="card-count">(${subcategory.cards ? subcategory.cards.length : 0} cards)</span>
                            </div>
                        `;
                        categoryDiv.appendChild(subDiv);
                    }
                }

                tree.appendChild(categoryDiv);
            }
        }

        function getTotalCards(category) {
            let total = 0;
            if (category.subcategories) {
                for (const sub of Object.values(category.subcategories)) {
                    total += sub.cards ? sub.cards.length : 0;
                }
            }
            return total;
        }

        function toggleCategory(categoryId) {
            const categoryCheckbox = document.getElementById(`cat-${categoryId}`);
            const isChecked = categoryCheckbox.checked;

            // Toggle all subcategories
            const category = flashcardData.categories[categoryId];
            if (category.subcategories) {
                for (const subId of Object.keys(category.subcategories)) {
                    const subCheckbox = document.getElementById(`sub-${categoryId}-${subId}`);
                    subCheckbox.checked = isChecked;
                }
            }

            updateSelectionCount();
        }

        function updateSelectionCount() {
            const checkboxes = document.querySelectorAll('#selection-tree input[type="checkbox"][id^="sub-"]');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const startBtn = document.getElementById('start-btn');

            startBtn.disabled = selectedCount === 0;

            // Update category checkboxes
            for (const [categoryId, category] of Object.entries(flashcardData.categories)) {
                const categoryCheckbox = document.getElementById(`cat-${categoryId}`);
                if (category.subcategories) {
                    const subCheckboxes = Object.keys(category.subcategories).map(subId =>
                        document.getElementById(`sub-${categoryId}-${subId}`)
                    );
                    const checkedSubs = subCheckboxes.filter(cb => cb.checked).length;

                    if (checkedSubs === 0) {
                        categoryCheckbox.checked = false;
                        categoryCheckbox.indeterminate = false;
                    } else if (checkedSubs === subCheckboxes.length) {
                        categoryCheckbox.checked = true;
                        categoryCheckbox.indeterminate = false;
                    } else {
                        categoryCheckbox.checked = false;
                        categoryCheckbox.indeterminate = true;
                    }
                }
            }
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('#selection-tree input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectionCount();
        }

        function clearAll() {
            const checkboxes = document.querySelectorAll('#selection-tree input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectionCount();
        }

        function startSession() {
            // Collect selected cards
            const selectedCards = [];

            for (const [categoryId, category] of Object.entries(flashcardData.categories)) {
                if (category.subcategories) {
                    for (const [subId, subcategory] of Object.entries(category.subcategories)) {
                        const checkbox = document.getElementById(`sub-${categoryId}-${subId}`);
                        if (checkbox && checkbox.checked && subcategory.cards) {
                            selectedCards.push(...subcategory.cards);
                        }
                    }
                }
            }

            if (selectedCards.length === 0) {
                showError('Please select at least one category');
                return;
            }

            // Initialize session
            sessionState.selectedCards = selectedCards;
            sessionState.currentQueue = shuffleArray([...selectedCards]);
            sessionState.currentCardIndex = 0;
            sessionState.isFlipped = false;
            sessionState.sessionActive = true;
            sessionState.startTime = Date.now();
            sessionState.stats = { known: 0, unknown: 0 };
            sessionState.knownCards = [];
            sessionState.unknownCards = [];

            showScreen('session-screen');
            displayCurrentCard();
            saveSession();
        }

        function displayCurrentCard() {
            const card = sessionState.currentQueue[sessionState.currentCardIndex];
            const progress = document.getElementById('progress');
            const cardFront = document.getElementById('card-front').querySelector('.card-content');
            const cardBack = document.getElementById('card-back').querySelector('.card-content');
            const flashcard = document.getElementById('flashcard');

            progress.textContent = `Card ${sessionState.currentCardIndex + 1} of ${sessionState.currentQueue.length}`;
            cardFront.textContent = card.front;
            cardBack.textContent = card.back;

            // Reset card to front
            sessionState.isFlipped = false;
            flashcard.classList.remove('flipped');
            document.getElementById('card-front').classList.add('active');
            document.getElementById('card-back').classList.remove('active');
        }

        function flipCard() {
            if (!sessionState.sessionActive) return;

            const flashcard = document.getElementById('flashcard');
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');

            sessionState.isFlipped = !sessionState.isFlipped;

            if (sessionState.isFlipped) {
                flashcard.classList.add('flipped');
                cardFront.classList.remove('active');
                cardBack.classList.add('active');
            } else {
                flashcard.classList.remove('flipped');
                cardFront.classList.add('active');
                cardBack.classList.remove('active');
            }
        }

        function markCard(known) {
            if (!sessionState.sessionActive) return;

            const currentCard = sessionState.currentQueue[sessionState.currentCardIndex];

            if (known) {
                sessionState.stats.known++;
                sessionState.knownCards.push(currentCard);
                // Remove from queue
                sessionState.currentQueue.splice(sessionState.currentCardIndex, 1);
            } else {
                sessionState.stats.unknown++;
                sessionState.unknownCards.push(currentCard);
                // Move to end of queue
                const card = sessionState.currentQueue.splice(sessionState.currentCardIndex, 1)[0];
                sessionState.currentQueue.push(card);
            }

            // Check if session is complete
            if (sessionState.currentQueue.length === 0) {
                completeSession();
                return;
            }

            // Adjust index if needed
            if (sessionState.currentCardIndex >= sessionState.currentQueue.length) {
                sessionState.currentCardIndex = 0;
            }

            displayCurrentCard();
            saveSession();
        }

        function completeSession() {
            sessionState.sessionActive = false;

            const sessionTime = Math.floor((Date.now() - sessionState.startTime) / 1000 / 60);
            document.getElementById('known-count').textContent = sessionState.stats.known;
            document.getElementById('unknown-count').textContent = sessionState.stats.unknown;
            document.getElementById('session-time').textContent = sessionTime + 'm';

            const continueBtn = document.getElementById('continue-btn');
            continueBtn.style.display = sessionState.unknownCards.length > 0 ? 'block' : 'none';

            clearSession();
            showScreen('results-screen');
        }

        function continueWithMissed() {
            if (sessionState.unknownCards.length === 0) return;

            sessionState.currentQueue = shuffleArray([...sessionState.unknownCards]);
            sessionState.currentCardIndex = 0;
            sessionState.isFlipped = false;
            sessionState.sessionActive = true;
            sessionState.startTime = Date.now();
            sessionState.stats = { known: 0, unknown: 0 };
            sessionState.knownCards = [];
            sessionState.unknownCards = [];

            showScreen('session-screen');
            displayCurrentCard();
            saveSession();
        }

        function pauseSession() {
            sessionState.sessionActive = false;
            saveSession();
            showScreen('selection-screen');
        }

        function quitSession() {
            sessionState.sessionActive = false;
            clearSession();
            showScreen('selection-screen');
        }

        function resumeSession() {
            const savedSession = getCookie('flashcard_session');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    sessionState = { ...sessionState, ...session };
                    sessionState.sessionActive = true;

                    showScreen('session-screen');
                    displayCurrentCard();
                    document.getElementById('resume-prompt').style.display = 'none';
                } catch (e) {
                    showError('Could not resume session: ' + e.message);